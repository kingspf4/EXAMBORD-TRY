<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期末考看板 - 趣味圖表版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; overflow: hidden; background-color: #f1f5f9; }
        
        /* 跑馬燈 */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: scroll-left 25s linear infinite; padding-left: 100%; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* 斜紋動畫背景 */
        .striped-bg {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-stripes 1s linear infinite;
        }
        @keyframes progress-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

        /* 輸入框樣式 */
        .clean-input { background: transparent; border-bottom: 2px solid #cbd5e1; transition: all 0.3s; text-align: center; }
        .clean-input:focus { border-bottom-color: #3b82f6; outline: none; background: rgba(255,255,255,0.8); }
        input[type="time"] { font-family: 'Consolas', monospace; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [now, setNow] = useState(new Date());
            const [marqueeText, setMarqueeText] = useState(() => localStorage.getItem('board_marquee') || "考試期間請保持安靜，檢查班級座號姓名是否正確。");
            const [isEditingMarquee, setIsEditingMarquee] = useState(false);
            const [schedule, setSchedule] = useState(() => JSON.parse(localStorage.getItem('board_schedule')) || [
                { subject: '國語', start: '08:40', end: '09:20' },
                { subject: '數學', start: '09:30', end: '10:10' },
                { subject: '英文', start: '10:30', end: '11:10' }
            ]);
            const [attendance, setAttendance] = useState(() => JSON.parse(localStorage.getItem('board_attendance')) || { expected: '30', actual: '29', absent: '15' });

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                localStorage.setItem('board_marquee', marqueeText);
                localStorage.setItem('board_schedule', JSON.stringify(schedule));
                localStorage.setItem('board_attendance', JSON.stringify(attendance));
            }, [marqueeText, schedule, attendance]);

            // 計算當前狀態
            const currentStatus = useMemo(() => {
                const currentMs = now.getHours() * 3600000 + now.getMinutes() * 60000 + now.getSeconds() * 1000;
                for (let item of schedule) {
                    const [sh, sm] = item.start.split(':').map(Number);
                    const [eh, em] = item.end.split(':').map(Number);
                    const startMs = sh * 3600000 + sm * 60000;
                    const endMs = eh * 3600000 + em * 60000;
                    if (currentMs >= startMs && currentMs < endMs) {
                        const percent = ((currentMs - startMs) / (endMs - startMs)) * 100;
                        const remaining = Math.ceil((endMs - currentMs) / 60000);
                        let color = 'bg-green-500';
                        if (remaining <= 5) color = 'bg-red-500';
                        else if (percent > 50) color = 'bg-yellow-400';
                        return { active: true, subject: item.subject, percent, color, remaining, start: item.start, end: item.end };
                    }
                }
                return { active: false, subject: '休息 / 準備中', percent: 0, color: 'bg-gray-300', remaining: 0 };
            }, [now, schedule]);

            // 計算整日時間軸 (Timeline)
            const timelineData = useMemo(() => {
                if (schedule.length === 0) return { startMs: 0, totalDuration: 1, items: [] };
                
                // 找出最早開始與最晚結束時間
                const times = schedule.flatMap(s => [s.start, s.end].map(t => {
                    const [h, m] = t.split(':').map(Number);
                    return h * 60 + m; // 轉為分鐘
                }));
                const minTime = Math.min(...times) - 10; // 提早10分鐘開始
                const maxTime = Math.max(...times) + 10; // 延後10分鐘結束
                const totalDuration = maxTime - minTime;

                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const progressPercent = Math.min(100, Math.max(0, (currentMinutes - minTime) / totalDuration * 100));

                const items = schedule.map((item, idx) => {
                    const [sh, sm] = item.start.split(':').map(Number);
                    const [eh, em] = item.end.split(':').map(Number);
                    const startMin = sh * 60 + sm;
                    const duration = (eh * 60 + em) - startMin;
                    
                    return {
                        left: ((startMin - minTime) / totalDuration) * 100,
                        width: (duration / totalDuration) * 100,
                        subject: item.subject,
                        active: currentStatus.subject === item.subject && currentStatus.active,
                        idx
                    };
                });

                return { items, progressPercent };
            }, [schedule, now, currentStatus]);

            const updateSchedule = (index, field, value) => {
                const newSchedule = [...schedule];
                newSchedule[index][field] = value;
                setSchedule(newSchedule);
            };

            // 出席率圖表計算
            const attendancePercent = useMemo(() => {
                const exp = parseInt(attendance.expected) || 1;
                const act = parseInt(attendance.actual) || 0;
                return Math.min(100, Math.max(0, (act / exp) * 100));
            }, [attendance]);

            return (
                <div className="flex flex-col h-screen w-screen bg-slate-50">
                    
                    {/* A區：頂部時鐘 + 當前進度 (20%) */}
                    <div className="h-[20vh] bg-white border-b-4 border-slate-200 flex shadow-sm relative z-20 overflow-hidden">
                        {/* 左側時鐘 */}
                        <div className="w-[30%] flex flex-col items-center justify-center bg-slate-100 border-r-2">
                            <span className="text-gray-400 font-bold tracking-widest text-xs uppercase">TIME</span>
                            <div className="text-[7vh] font-black leading-none text-slate-800 tabular-nums">
                                {now.toLocaleTimeString('zh-TW', { hour12: false })}
                            </div>
                        </div>
                        {/* 右側當前進度 */}
                        <div className="w-[70%] flex flex-col justify-center px-8 relative">
                            <div className="flex justify-between items-end mb-2">
                                <div className="flex items-baseline gap-3">
                                    <span className={`text-[5vh] font-black ${currentStatus.active ? 'text-blue-600' : 'text-gray-400'}`}>
                                        {currentStatus.subject}
                                    </span>
                                    {currentStatus.active && (
                                        <span className="text-xl font-bold text-slate-500">
                                            {currentStatus.start} ~ {currentStatus.end}
                                        </span>
                                    )}
                                </div>
                                <div className={`text-2xl font-bold ${currentStatus.remaining <= 5 && currentStatus.active ? 'text-red-500 animate-pulse' : 'text-slate-400'}`}>
                                    {currentStatus.active ? `剩餘 ${currentStatus.remaining} 分` : '休息中'}
                                </div>
                            </div>
                            {/* 當前科目進度條 */}
                            <div className="w-full h-6 bg-slate-200 rounded-full overflow-hidden shadow-inner border border-slate-300">
                                <div 
                                    className={`h-full ${currentStatus.color} striped-bg transition-all duration-1000 ease-linear`} 
                                    style={{ width: `${currentStatus.percent}%` }}
                                ></div>
                            </div>
                        </div>
                    </div>

                    {/* B區：整日時間軸長條圖 (10%) - 有趣的新功能 */}
                    <div className="h-[10vh] bg-slate-800 flex items-center px-8 relative overflow-hidden border-b-4 border-slate-600">
                        <div className="absolute left-4 text-xs font-bold text-slate-400 uppercase tracking-widest">TIMELINE</div>
                        <div className="w-full h-8 bg-slate-700 rounded-lg relative mt-2">
                            {/* 各科目色塊 */}
                            {timelineData.items.map((item, i) => (
                                <div 
                                    key={i}
                                    className={`absolute top-0 bottom-0 rounded shadow-sm border border-white/10 flex items-center justify-center text-xs font-bold text-white truncate px-1 transition-all ${item.active ? 'bg-blue-500 z-10 scale-y-110 shadow-lg ring-2 ring-white' : 'bg-slate-500 opacity-70'}`}
                                    style={{ left: `${item.left}%`, width: `${item.width}%` }}
                                >
                                    {item.width > 5 && item.subject}
                                </div>
                            ))}
                            {/* 現在時間指針 */}
                            <div 
                                className="absolute top-[-5px] bottom-[-5px] w-1 bg-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.8)] z-20 transition-all duration-1000 ease-linear"
                                style={{ left: `${timelineData.progressPercent}%` }}
                            >
                                <div className="absolute -top-1 -left-[5px] w-3 h-3 bg-yellow-400 rounded-full"></div>
                            </div>
                        </div>
                    </div>

                    {/* C區：主內容 (40%) - 左考程 右跑馬燈 */}
                    <div className="h-[40vh] flex bg-slate-50">
                        {/* 考程表 */}
                        <div className="w-2/3 p-4 overflow-y-auto">
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                                <div className="flex justify-between mb-2">
                                    <h3 className="font-bold text-slate-500">考程設定</h3>
                                    <button onClick={() => setSchedule([...schedule, {subject:'', start:'', end:''}])} className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold">+ 新增</button>
                                </div>
                                <div className="space-y-2">
                                    {schedule.map((item, i) => (
                                        <div key={i} className={`flex items-center gap-2 p-2 rounded-lg border-l-4 ${currentStatus.subject === item.subject && currentStatus.active ? 'border-blue-500 bg-blue-50' : 'border-slate-300 bg-slate-50'}`}>
                                            <div className="w-6 text-center font-bold text-slate-400">{i+1}</div>
                                            <input className="flex-1 font-bold text-xl bg-transparent outline-none text-slate-700" value={item.subject} onChange={(e)=>updateSchedule(i,'subject',e.target.value)} placeholder="科目" />
                                            <input type="time" className="bg-transparent font-mono font-bold" value={item.start} onChange={(e)=>updateSchedule(i,'start',e.target.value)} />
                                            <span className="text-slate-400">~</span>
                                            <input type="time" className="bg-transparent font-mono font-bold" value={item.end} onChange={(e)=>updateSchedule(i,'end',e.target.value)} />
                                            <button onClick={()=>setSchedule(schedule.filter((_,idx)=>idx!==i))} className="text-slate-300 hover:text-red-400 px-2">×</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* 跑馬燈與提醒 */}
                        <div className="w-1/3 p-4 pl-0 flex flex-col">
                            <div className="flex-1 bg-yellow-100 rounded-2xl border-4 border-yellow-200 p-4 flex flex-col relative overflow-hidden shadow-inner">
                                <div className="absolute top-2 left-3 bg-yellow-400 text-white text-xs px-2 py-0.5 rounded font-bold">動態提醒</div>
                                {isEditingMarquee ? (
                                    <textarea className="w-full h-full mt-6 bg-white/50 p-2 rounded text-lg font-bold outline-none resize-none" value={marqueeText} onChange={(e)=>setMarqueeText(e.target.value)} onBlur={()=>setIsEditingMarquee(false)} autoFocus />
                                ) : (
                                    <div className="flex-1 flex items-center overflow-hidden cursor-pointer" onClick={()=>setIsEditingMarquee(true)} title="點擊編輯">
                                        <div className="marquee-container w-full">
                                            <div className="marquee-content text-3xl font-black text-slate-800">
                                                {marqueeText}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* D區：底部統計長條圖 (30%) */}
                    <div className="h-[30vh] bg-slate-800 p-6 flex gap-6 text-white">
                        
                        {/* 應到實到圖表區 */}
                        <div className="flex-1 flex gap-4">
                            {/* 應到卡片 */}
                            <div className="flex-1 bg-slate-700 rounded-2xl p-4 flex flex-col justify-between relative overflow-hidden group">
                                <span className="z-10 text-sm font-bold opacity-70 tracking-widest">EXPECTED / 應到</span>
                                <input type="number" className="z-10 w-full bg-transparent text-[6vh] font-black outline-none text-blue-300" value={attendance.expected} onChange={(e)=>setAttendance({...attendance, expected: e.target.value})} />
                                {/* 裝飾長條 (背景) */}
                                <div className="absolute bottom-0 left-0 w-full h-2 bg-blue-900"></div>
                                <div className="absolute right-0 top-0 bottom-0 w-2 bg-blue-500/20 group-hover:w-full transition-all duration-500"></div>
                            </div>

                            {/* 實到卡片 (含長條圖) */}
                            <div className="flex-1 bg-slate-700 rounded-2xl p-4 flex flex-col justify-between relative overflow-hidden">
                                <span className="z-10 text-sm font-bold opacity-70 tracking-widest">ACTUAL / 實到</span>
                                <div className="flex items-baseline gap-2 z-10">
                                    <input type="number" className="w-24 bg-transparent text-[6vh] font-black outline-none text-emerald-300" value={attendance.actual} onChange={(e)=>setAttendance({...attendance, actual: e.target.value})} />
                                    <span className="text-emerald-500 font-bold text-lg">
                                        ({Math.round(attendancePercent)}%)
                                    </span>
                                </div>
                                {/* 實到比例長條圖 */}
                                <div className="absolute bottom-0 left-0 w-full h-4 bg-slate-900">
                                    <div className="h-full bg-emerald-500 transition-all duration-1000" style={{width: `${attendancePercent}%`}}></div>
                                </div>
                            </div>
                        </div>

                        {/* 缺席名單 */}
                        <div className="w-[35%] bg-rose-900/40 border-2 border-rose-500/30 rounded-2xl p-4 flex flex-col relative">
                            <span className="text-sm font-bold text-rose-300 tracking-widest mb-2">ABSENT / 缺席座號</span>
                            <textarea className="flex-1 w-full bg-transparent text-[4vh] font-bold outline-none resize-none leading-tight placeholder-rose-800/50 text-rose-100 text-center" value={attendance.absent} onChange={(e)=>setAttendance({...attendance, absent: e.target.value})} placeholder="無缺席" />
                        </div>

                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
