<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>期末考看板 - 時間視覺化版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; overflow: hidden; background-color: #f8fafc; }
        
        /* 跑馬燈動畫 */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: scroll-left 20s linear infinite; padding-left: 100%; }
        .marquee-content:hover { animation-play-state: paused; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* 進度條過渡動畫 */
        .progress-bar-transition { transition: width 1s linear, background-color 0.5s ease; }

        /* 輸入框樣式 */
        .clean-input { background: transparent; border-bottom: 2px solid #cbd5e1; transition: all 0.3s; text-align: center; }
        .clean-input:focus { border-bottom-color: #3b82f6; outline: none; background: rgba(255,255,255,0.5); }
        input[type="time"] { font-family: 'Consolas', monospace; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            // 1. 核心狀態
            const [now, setNow] = useState(new Date());
            const [marqueeText, setMarqueeText] = useState(() => localStorage.getItem('board_marquee') || "請檢查班級、座號、姓名是否填寫正確，考試期間請保持安靜。");
            const [isEditingMarquee, setIsEditingMarquee] = useState(false);
            const [schedule, setSchedule] = useState(() => JSON.parse(localStorage.getItem('board_schedule')) || [
                { subject: '國語', start: '08:40', end: '09:20' },
                { subject: '數學', start: '09:30', end: '10:10' },
                { subject: '英文', start: '10:30', end: '11:10' }
            ]);
            const [attendance, setAttendance] = useState(() => JSON.parse(localStorage.getItem('board_attendance')) || { expected: '', actual: '', absent: '' });

            // 計時器
            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            // 自動存檔
            useEffect(() => {
                localStorage.setItem('board_marquee', marqueeText);
                localStorage.setItem('board_schedule', JSON.stringify(schedule));
                localStorage.setItem('board_attendance', JSON.stringify(attendance));
            }, [marqueeText, schedule, attendance]);

            // 計算當前考試狀態與進度
            const currentStatus = useMemo(() => {
                const currentMs = now.getHours() * 3600000 + now.getMinutes() * 60000 + now.getSeconds() * 1000;
                
                for (let item of schedule) {
                    const [sh, sm] = item.start.split(':').map(Number);
                    const [eh, em] = item.end.split(':').map(Number);
                    const startMs = sh * 3600000 + sm * 60000;
                    const endMs = eh * 3600000 + em * 60000;

                    if (currentMs >= startMs && currentMs < endMs) {
                        const totalDuration = endMs - startMs;
                        const elapsed = currentMs - startMs;
                        const percent = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                        const remainingMinutes = Math.ceil((endMs - currentMs) / 60000);
                        
                        // 決定顏色
                        let color = 'bg-green-500';
                        if (remainingMinutes <= 5) color = 'bg-red-600'; // 最後5分鐘
                        else if (percent > 50) color = 'bg-yellow-400'; // 過半

                        return { active: true, subject: item.subject, percent, color, remaining: remainingMinutes };
                    }
                }
                return { active: false, subject: '休息 / 準備中', percent: 0, color: 'bg-gray-300', remaining: 0 };
            }, [now, schedule]);

            // 更新考程
            const updateSchedule = (index, field, value) => {
                const newSchedule = [...schedule];
                newSchedule[index][field] = value;
                setSchedule(newSchedule);
            };

            const addSubject = () => setSchedule([...schedule, { subject: '', start: '', end: '' }]);
            const removeSubject = (index) => setSchedule(schedule.filter((_, i) => i !== index));

            return (
                <div className="flex flex-col h-screen w-screen">
                    
                    {/* A區：頂部大時鐘 + 視覺化時間條 (固定高度 25%) */}
                    <div className="h-[25vh] bg-white border-b-4 border-gray-200 flex flex-col shadow-sm relative z-20">
                        {/* 時鐘部分 */}
                        <div className="flex-1 flex items-center justify-center">
                            <div className="flex flex-col items-center">
                                <span className="text-gray-400 font-bold tracking-[0.5em] text-xs uppercase">Current Time</span>
                                <div className="text-[9vh] font-black leading-none text-slate-800 tabular-nums">
                                    {now.toLocaleTimeString('zh-TW', { hour12: false })}
                                </div>
                            </div>
                        </div>

                        {/* 視覺化時間條部分 */}
                        <div className="h-[6vh] bg-slate-100 px-6 pb-2 flex flex-col justify-center">
                            <div className="flex justify-between items-end mb-1 px-1">
                                <div className="flex items-baseline gap-2">
                                    <span className={`font-black text-2xl ${currentStatus.active ? 'text-blue-600' : 'text-gray-400'}`}>
                                        {currentStatus.subject}
                                    </span>
                                    {currentStatus.active && <span className="text-sm font-bold text-gray-500">進行中</span>}
                                </div>
                                <div className={`font-bold text-xl ${currentStatus.remaining <= 5 && currentStatus.active ? 'text-red-600 animate-pulse' : 'text-slate-600'}`}>
                                    {currentStatus.active ? `剩餘 ${currentStatus.remaining} 分鐘` : '等待開始'}
                                </div>
                            </div>
                            {/* 進度條軌道 */}
                            <div className="w-full h-4 bg-gray-200 rounded-full overflow-hidden shadow-inner border border-gray-300">
                                <div 
                                    className={`h-full ${currentStatus.color} progress-bar-transition`} 
                                    style={{ width: `${currentStatus.percent}%` }}
                                ></div>
                            </div>
                        </div>
                    </div>

                    {/* B區：動態跑馬燈 (固定高度 6%) */}
                    <div className="h-[6vh] bg-yellow-400 flex items-center overflow-hidden relative border-b-4 border-yellow-500 shadow-md z-10">
                        {isEditingMarquee ? (
                            <div className="w-full flex px-4 gap-2">
                                <input 
                                    className="flex-1 px-4 py-1 rounded text-lg font-bold outline-none" 
                                    value={marqueeText} 
                                    onChange={(e) => setMarqueeText(e.target.value)} 
                                    autoFocus
                                />
                                <button onClick={() => setIsEditingMarquee(false)} className="bg-black text-white px-4 rounded font-bold">完成</button>
                            </div>
                        ) : (
                            <div className="w-full h-full flex items-center marquee-container cursor-pointer" onClick={() => setIsEditingMarquee(true)} title="點擊編輯跑馬燈">
                                <div className="marquee-content text-[3.5vh] font-black text-slate-900 leading-none pt-1">
                                    {marqueeText}
                                </div>
                            </div>
                        )}
                        <div className="absolute left-0 top-0 bottom-0 bg-yellow-600 text-white px-4 flex items-center font-bold z-10 shadow-r-md">
                            提醒
                        </div>
                    </div>

                    {/* C區：考程表 (自動伸縮) */}
                    <div className="flex-1 bg-slate-100 p-4 overflow-y-auto">
                        <div className="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-5">
                            <div className="flex justify-between items-center mb-3 border-b pb-2">
                                <h2 className="text-xl font-black text-slate-700 border-l-8 border-blue-500 pl-3">考試時間表</h2>
                                <button onClick={addSubject} className="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-sm font-bold hover:bg-blue-200 transition">+ 新增</button>
                            </div>
                            
                            <div className="space-y-2">
                                {schedule.map((item, i) => {
                                    // 判斷是否為當前科目，若是則加強顯示
                                    const isCurrent = currentStatus.subject === item.subject && currentStatus.active;
                                    return (
                                        <div key={i} className={`flex items-center gap-4 p-2 rounded-xl transition-all border-l-4 ${isCurrent ? 'bg-blue-50 border-blue-500 shadow-md scale-[1.01]' : 'bg-slate-50 border-transparent hover:bg-white hover:shadow-sm'}`}>
                                            <div className={`w-8 text-center font-bold ${isCurrent ? 'text-blue-600' : 'text-gray-400'}`}>{i + 1}</div>
                                            <input 
                                                className="flex-1 text-2xl font-black clean-input text-left text-slate-800" 
                                                value={item.subject} 
                                                onChange={(e) => updateSchedule(i, 'subject', e.target.value)} 
                                                placeholder="科目"
                                            />
                                            <div className="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border">
                                                <input type="time" className="text-xl font-bold outline-none bg-transparent" value={item.start} onChange={(e) => updateSchedule(i, 'start', e.target.value)} />
                                                <span className="text-gray-400 font-bold">~</span>
                                                <input type="time" className="text-xl font-bold outline-none bg-transparent" value={item.end} onChange={(e) => updateSchedule(i, 'end', e.target.value)} />
                                            </div>
                                            <button onClick={() => removeSubject(i)} className="text-gray-300 hover:text-red-500 px-2 font-bold">✕</button>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* D區：底部統計 (固定高度 20%) */}
                    <div className="h-[20vh] bg-slate-800 flex items-stretch p-4 gap-4">
                        {/* 應到 */}
                        <div className="flex-1 bg-blue-600 rounded-2xl flex flex-col items-center justify-center text-white relative shadow-lg overflow-hidden group">
                            <span className="absolute top-2 left-4 text-xs font-bold opacity-70 tracking-widest">EXPECTED / 應到</span>
                            <input type="number" className="w-full bg-transparent text-center text-[8vh] font-black outline-none placeholder-blue-400" value={attendance.expected} onChange={(e) => setAttendance({...attendance, expected: e.target.value})} placeholder="0" />
                        </div>
                        {/* 實到 */}
                        <div className="flex-1 bg-emerald-500 rounded-2xl flex flex-col items-center justify-center text-white relative shadow-lg overflow-hidden">
                            <span className="absolute top-2 left-4 text-xs font-bold opacity-70 tracking-widest">ACTUAL / 實到</span>
                            <input type="number" className="w-full bg-transparent text-center text-[8vh] font-black outline-none placeholder-emerald-300" value={attendance.actual} onChange={(e) => setAttendance({...attendance, actual: e.target.value})} placeholder="0" />
                        </div>
                        {/* 缺考 */}
                        <div className="flex-[1.5] bg-rose-600 rounded-2xl flex flex-col relative shadow-lg overflow-hidden p-2">
                            <span className="absolute top-2 left-4 text-xs font-bold opacity-70 tracking-widest">ABSENT / 缺考名單</span>
                            <textarea className="w-full h-full bg-transparent text-center text-[4vh] font-bold outline-none resize-none pt-6 leading-tight placeholder-rose-400" value={attendance.absent} onChange={(e) => setAttendance({...attendance, absent: e.target.value})} placeholder="輸入座號..." />
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
